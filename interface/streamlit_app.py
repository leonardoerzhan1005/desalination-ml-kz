import streamlit as st
import pandas as pd
import numpy as np
import joblib
import os
import plotly.express as px
import seaborn as sns
import matplotlib.pyplot as plt
from fpdf import FPDF

# –ú–æ–¥–µ–ª—å–¥—ñ –∂“Ø–∫—Ç–µ—É
model = joblib.load("models/kz_model.pkl")

# –ñ–æ“ì–∞—Ä—ã –¥”ô–ª–¥—ñ–∫—Ç—ñ –¥–∞—Ç–∞
history_path = "data/prediction_history.csv"
if os.path.exists(history_path):
    history_df = pd.read_csv(history_path)
else:
    history_df = pd.DataFrame(columns=[
        "”©“£—ñ—Ä", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "—Ç“±–∑–¥—ã–ª—ã“õ", "pH", "–∫—ñ—Ä—É_“õ—ã—Å—ã–º—ã", "—Å—É_–¥–µ“£–≥–µ–π—ñ", "—à—ã“ì—ã—Å_“õ—ã—Å—ã–º—ã"
    ])

# –†–µ–∞–ª–∏—Å—Ç—ñ–∫ –¥–∞—Ç–∞—Å–µ—Ç—Ç—ñ –∂“Ø–∫—Ç–µ—É (–∞–Ω–∞–ª–∏–∑ “Ø—à—ñ–Ω)
df = pd.read_csv("data/sensor_data_kz_realistic.csv")
df["—É–∞“õ—ã—Ç"] = pd.to_datetime(df["—É–∞“õ—ã—Ç"])

st.set_page_config(page_title="–°—É–¥—ã —Ç“±—â—ã–ª–∞–Ω–¥—ã—Ä—É –∂“Ø–π–µ—Å—ñ", layout="centered")
st.title("üíß –°—É–¥—ã —Ç“±—â—ã–ª–∞–Ω–¥—ã—Ä—É ‚Äì “õ—ã—Å—ã–º –±–æ–ª–∂–∞–º—ã")

with st.expander("‚ÑπÔ∏è –ñ“Ø–π–µ —Ç—É—Ä–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç"):
    st.markdown("""
    –ë“±–ª –∂“Ø–π–µ **—Å—É–¥—ã —Ç“±—â—ã–ª–∞–Ω–¥—ã—Ä—É –ø—Ä–æ—Ü–µ—Å—ñ–Ω –∞–≤—Ç–æ–º–∞—Ç—Ç—ã –±–∞—Å“õ–∞—Ä—É“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω**.

    üß† **–ñ–∞—Å–∞–Ω–¥—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç** –∞—Ä“õ—ã–ª—ã –µ–Ω–≥—ñ–∑—ñ–ª–≥–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä–≥–µ “õ–∞—Ä–∞–ø,
    “õ–∞–∂–µ—Ç—Ç—ñ —à—ã“ì—ã—Å “õ—ã—Å—ã–º—ã–Ω –±–æ–ª–∂–∞–π–¥—ã.

    **–ü–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä:** —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, —Ç“±–∑–¥—ã–ª—ã“õ, pH, “õ—ã—Å—ã–º, —Å—É –¥–µ“£–≥–µ–π—ñ, ”©“£—ñ—Ä
    """)

# üìê –§–æ—Ä–º—É–ª–∞–ª–∞—Ä –º–µ–Ω —Ç–µ–æ—Ä–∏—è
with st.expander("üìê –§–æ—Ä–º—É–ª–∞–ª–∞—Ä –º–µ–Ω —Ç–µ–æ—Ä–∏—è"):
    st.latex(r"""
    \text{P}_{—à—ã“ì—ã—Å} = 0.0025 \cdot \text{TDS} + 0.05 \cdot \text{Temp} - 0.3 \cdot \text{pH} + \varepsilon
    """)
    st.latex(r"""
    \pi = iMRT
    """)
    st.markdown("""
    **–ú“±–Ω–¥–∞“ì—ã:**
    - **TDS** ‚Äî —Ç“±–∑–¥—ã–ª—ã“õ (ppm)
    - **Temp** ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)
    - **pH** ‚Äî —Å—É “õ—ã—à“õ—ã–ª–¥—ã“ì—ã
    - **\( \varepsilon \)** ‚Äî –º–æ–¥–µ–ª—å–¥–µ–≥—ñ –∫–µ–∑–¥–µ–π—Å–æ“õ –∞—É—ã—Ç“õ—É (–Ω–æ—Ä–º–∞–ª—å –±”©–ª—ñ–Ω–≥–µ–Ω)
    - **\( \pi \)** ‚Äî –æ—Å–º–æ—Å—Ç—ã“õ “õ—ã—Å—ã–º
    - **i** ‚Äî –í–∞–Ω-–ì–æ—Ñ—Ñ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ñ
    - **M** ‚Äî –º–æ–ª—è—Ä–ª—ã“õ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è
    - **R** ‚Äî –≥–∞–∑ —Ç“±—Ä–∞“õ—Ç—ã—Å—ã
    - **T** ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (–ö)
    """)

# üîÑ –°—É —Ç“±—â—ã–ª–∞–Ω–¥—ã—Ä—É –ø—Ä–æ—Ü–µ—Å—ñ–Ω –∏–º–∏—Ç–∞—Ü–∏—è–ª–∞—É (2 –∫–µ–∑–µ“£)
st.header("üö∞ –°—É —Ç“±—â—ã–ª–∞–Ω–¥—ã—Ä—É –∫–µ–∑–µ“£–¥–µ—Ä—ñ")
initial_salinity = st.number_input("–ë–∞—Å—Ç–∞–ø“õ—ã —Ç“±–∑–¥—ã–ª—ã“õ (ppm)", value=6000, step=100)
temperature = st.slider("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)", 0.0, 45.0, 25.0)
ph = st.slider("pH", 5.0, 9.0, 7.0)
input_pressure = st.slider("–ö—ñ—Ä—É “õ—ã—Å—ã–º—ã (–±–∞—Ä)", 1.0, 6.0, 3.0)

# –ù–∞–Ω–æ—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω”ô—Ç–∏–∂–µ—Å—ñ
nano = {
    "–¢“±–∑–¥—ã–ª—ã“õ": initial_salinity * 0.5,
    "pH": ph - 0.2,
    "“ö—ã—Å—ã–º": input_pressure + 0.5,
    "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞": temperature
}

# –ö–µ—Ä—ñ –æ—Å–º–æ—Å –Ω”ô—Ç–∏–∂–µ—Å—ñ
osmosis = {
    "–¢“±–∑–¥—ã–ª—ã“õ": nano["–¢“±–∑–¥—ã–ª—ã“õ"] * 0.1,
    "pH": nano["pH"] - 0.1,
    "“ö—ã—Å—ã–º": nano["“ö—ã—Å—ã–º"] + 1.5,
    "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞": nano["–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞"]
}

# –ö–µ—Å—Ç–µ–ª—ñ–∫ –∫”©—Ä—ñ–Ω—ñ—Å –∂”ô–Ω–µ –≥—Ä–∞—Ñ–∏–∫
params_df = pd.DataFrame([
    {"–ö–µ–∑–µ“£": "–ë–∞—Å—Ç–∞–ø“õ—ã", **{"–¢“±–∑–¥—ã–ª—ã“õ": initial_salinity, "pH": ph, "“ö—ã—Å—ã–º": input_pressure, "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞": temperature}},
    {"–ö–µ–∑–µ“£": "–ù–∞–Ω–æ—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è", **nano},
    {"–ö–µ–∑–µ“£": "–ö–µ—Ä—ñ –æ—Å–º–æ—Å", **osmosis}
])

st.subheader("–°—É –ø–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä—ñ–Ω—ñ“£ –∫–µ–∑–µ“£ –±–æ–π—ã–Ω—à–∞ ”©–∑–≥–µ—Ä—ñ—Å—ñ")
st.dataframe(params_df.set_index("–ö–µ–∑–µ“£"))
fig = px.line(params_df, x="–ö–µ–∑–µ“£", y=["–¢“±–∑–¥—ã–ª—ã“õ", "pH", "“ö—ã—Å—ã–º", "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞"], markers=True,
              title="”ò—Ä ”ô–¥—ñ—Å—Ç–µ–Ω –∫–µ–π—ñ–Ω–≥—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä–¥—ñ“£ ”©–∑–≥–µ—Ä—ñ—Å—ñ")
st.plotly_chart(fig)

# “ö–æ—Ä—ã—Ç—ã–Ω–¥—ã
st.subheader("“ö–æ—Ä—ã—Ç—ã–Ω–¥—ã")
final_salinity = osmosis["–¢“±–∑–¥—ã–ª—ã“õ"]
if final_salinity <= 500:
    st.success(f"üü¢ –°–æ“£“ì—ã —Ç“±–∑–¥—ã–ª—ã“õ: {final_salinity:.2f} ppm ‚Äî –±“±–ª —Å—É –∞—É—ã–∑ —Å—É “Ø—à—ñ–Ω –∂–∞—Ä–∞–º–¥—ã ‚úÖ")
else:
    st.error(f"üî¥ –°–æ“£“ì—ã —Ç“±–∑–¥—ã–ª—ã“õ: {final_salinity:.2f} ppm ‚Äî –±“±–ª —Å—É ”ô–ª—ñ –¥–µ –∂–∞—Ä–∞–º—Å—ã–∑ ‚ö†Ô∏è")
